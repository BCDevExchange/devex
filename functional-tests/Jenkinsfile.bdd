stage('Functional Test Dev') {
    podTemplate(label: 'devxp-bdd', name: 'devxp-bdd', serviceAccount: 'jenkins', cloud: 'openshift', containers: [
      containerTemplate(
        name: 'jnlp',
        image: '172.50.0.2:5000/openshift/jenkins-slave-bddstack',
        resourceRequestCpu: '500m',
        resourceLimitCpu: '2000m',
        resourceRequestMemory: '2Gi',
        resourceLimitMemory: '8Gi',
        workingDir: '/home/jenkins',
        command: '',
        args: '${computer.jnlpmac} ${computer.name}',
        envVars: [
            envVar(key:'BASEURL', value: 'http://platform-dev.pathfinder.gov.bc.ca/')
        ],
	volumes: [
	    emptyDirVolume(mountPath:'/dev/shm', memory: true)
	]
      )
    ]) {
      node('devxp-bdd') {
	//the checkout is mandatory, otherwise functional test would fail
        echo "checking out source"
        checkout scm
	//sleep 600
        dir('functional-tests') {
            try {
              sh './gradlew --debug chromeHeadlessTest'
            } finally { 
              archiveArtifacts allowEmptyArchive: true, artifacts: 'build/reports/**/*'
              archiveArtifacts allowEmptyArchive: true, artifacts: 'build/test-results/**/*'
              junit 'build/test-results/**/*.xml'
              publishHTML (target: [
                                allowMissing: false,
                                alwaysLinkToLastBuild: false,
                                keepAll: true,
                                reportDir: 'build/reports/spock',
                                reportFiles: 'index.html',
                                reportName: "BDD Spock Report"
                          ])
              publishHTML (target: [
                                allowMissing: false,
                                alwaysLinkToLastBuild: false,
                                keepAll: true,
                                reportDir: 'build/reports/tests/chromeHeadlessTest',
                                reportFiles: 'index.html',
                                reportName: "Full Test Report"
                          ])  
	    }
        }
     }
   }
}
