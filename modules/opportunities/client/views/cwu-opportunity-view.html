<div class="back-nav">
  <div class="container">
    <div class="row">
      <div class="col">
        <a href="/opportunities"><i class="fas fa-chevron-left"></i>&nbsp;&nbsp;All Opportunities</a>
      </div>
    </div>
  </div>
</div>

<!-- Proposal evaluation section for opportunity admins -->
<section class="bg-dark" ng-if="vm.canEdit && vm.opportunity.isPublished">
  <div class="container">
    <!-- // Proposal Evaluation // -->
    <div class="border rounded bg-white p-4">

      <!-- Proposal list -->
      <proposal-list ng-if="vm.opportunity.status === 'Pending' " isclosed="vm.closing === 'CLOSED'"
            context="opportunity" opportunity="vm.opportunity"></proposal-list>           
        

      <!-- If opportunity has been asssigned, show the assignee -->
      <div class="row py-3" ng-if="vm.opportunity.status !== 'Pending' && vm.opportunity.proposal">
        <div class="col text-center">
          <span class="text-black-50">Opportunity assigned to:</span>
          &nbsp;
          <img class="img-avatar-flat img-avatar-sm" src="{{((vm.opportunity.proposal.user.profileImageURL.substr(0,1) == '/' || vm.opportunity.proposal.user.profileImageURL.substr(0,4) == 'http') ? '' : '/') + vm.opportunity.proposal.user.profileImageURL}}">
          &nbsp;
          {{vm.opportunity.proposal.user.displayName}}
          &nbsp;&nbsp;&nbsp;
          <a id="proposals.view" ng-if="vm.canEdit || vm.isMember" ui-sref="proposals.viewcwu({ proposalId: vm.opportunity.proposal._id })">View
            Proposal</a>&nbsp;&nbsp;
          <button class="btn btn-sm btn-text-only" ng-if="vm.canEdit" ng-click="vm.unassign()"><i class="fas fa-ban"></i>
            Unassign</button>
        </div>
      </div>
      
      <!-- Download archive of proposals if opportunity is closed -->
      <div class="row py-3" ng-if="vm.canEdit && vm.closing === 'CLOSED'">
        <div class="col text-center">
          <a href="/api/proposals/archive/opportunity/{{vm.opportunity._id}}" class="btn btn-outline-secondary" target="_blank"><i class="fas fa-file-archive"></i>
            Download Proposals Archive</a>
        </div>
      </div>

    </div>
  </div>
</section><!-- END: Proposal evaluation section for opportunity admins -->

<!-- Section for opportunity admin if opportunity is in draft and incomplete  -->
<section ng-if="!vm.canPublish && !vm.opportunity.isPublished && vm.canEdit && vm.closing !== 'CLOSED'" class="bg-light">
  <div class="container">
    <div class="row py-3">
      <div class="col">
        <div class="alert alert-warning">
          <span class="strong"><i class="fas fa-exclamation-triangle"></i> Your opportunity is missing stuff!</span>
          Before you can publish, you'll need to define these things:
          <ul style="text-align: left;">
            <li ng-repeat="fname in vm.errorFields">{{fname}}</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</section>


<!-- Main opportunity detail view -->
<section class="main-section">
  <div class="container">

    <!-- Watch buttons if user is signed in, has an email in their profile, and is not admin for the opportunity -->
    <div class="row py-2 text-right" ng-if="vm.loggedIn && !vm.canEdit && vm.hasEmail">
      <div class="col">
        <!-- If user is not watching -->
        <button class="btn btn-primary" ng-if="!vm.isWatching"
        title="Get email notifications if this opportunity changes" ng-click="vm.toggleWatch()">
          <i class="fas fa-eye"></i>
        Watch
        </button>
        <!-- If user is watching -->
        <button class="btn btn-secondary" ng-if="vm.isWatching"
        title="You're subscribed to get email notifications if this opportunity changes" ng-click="vm.toggleWatch()">
          <i class="fas fa-eye"></i>
        Watching
        </button>
      </div>
    </div>    

    <!-- Edit / Publish buttons for Admin -->
    <div class="row d-none d-sm-block text-right" ng-if="vm.canEdit">
      <div class="col">
          
          <!-- PUBLISH (if opportunity is in DRAFT and COMPLETE) -->
          <button data-automation-id="button-opportunity-publish" ng-if="vm.canPublish && !vm.opportunity.isPublished"
            class="btn btn-text-only" ng-click="vm.publish(vm.opportunity, true)" title="Publish this opportunity"><i
              class="fas fa-bullhorn"></i> Publish</button>

          <!-- UNPUBLISH (if opportunity is PUBLISHED) -->
          <a data-automation-id="button-opportunity-unpublish" href="javascript:void(0);" ng-if="vm.canEdit && vm.opportunity.isPublished"
            class="btn btn-text-only" ng-click="vm.publish(vm.opportunity, false)" title="Unpublish this opportunity">
            <i class="fas fa-times"></i> Unpublish
          </a>
          
          <!-- EDIT -->
          <a data-automation-id="button-opportunity-edit" class="btn btn-text-only" ng-if="vm.canEdit" ui-sref="opportunityadmin.editcwu({opportunityId:vm.opportunity.code})"
            title="Edit this opportunity">
            <i class="fas fa-pencil-alt"></i> Edit
          </a>

      </div>
    </div>

    <!-- // Closing deadline while opportunity is still open // -->
    <div class="row py-1" ng-if="vm.opportunity.isPublished">
      <div class="col">
        <div ng-if="vm.closing !== 'CLOSED'">
          <p class="text-muted mb-0"><label class="label label-lg label-success">OPEN</label> Proposals must be received through this website before {{vm.deadline}}.</p>
        </div>
        <div ng-if="vm.closing === 'CLOSED'">
          <p class="text-muted mb-0"><label class="label label-lg label-danger">CLOSED</label> This opportunity closed on {{vm.deadline}}.</p>
        </div>
      </div>
    </div>

    <!-- // Non-admin view of assignee AFTER the opportunity is assigned // -->
    <div class="row py-3" ng-if="vm.opportunity.status !== 'Pending' && !vm.canEdit && vm.opportunity.proposal">
      <div class="col">
        <span class="text-black-50">Opportunity assigned to:</span>
        &nbsp;
        <img class="img-avatar-flat img-avatar-sm" src="{{((vm.opportunity.proposal.user.profileImageURL.substr(0,1) == '/' || vm.opportunity.proposal.user.profileImageURL.substr(0,4) == 'http') ? '' : '/') + vm.opportunity.proposal.user.profileImageURL}}">
        &nbsp;
        {{vm.opportunity.proposal.user.displayName}}
      </div>
    </div>

    <!-- // Title and Teaser // -->
    <div class="row py-5">
      <div class="col">
        <label class="label label-swu"><i class="fas fa-tag"></i> Code With Us</label>
        <h2 data-automation-id="text-opportunity-name">{{vm.opportunity.name}}</h2>
        <p ng-bind="vm.opportunity.short"></p>
      </div>
    </div>
    
    <div class="row p-3 my-5 bg-light rounded">
      <div class="col-lg-5 opp-dl-description">
        <dl class="row">
          <dt class="col-6 text-right">Value:</dt>
          <dd class="col-6 text-left">{{ vm.opportunity.earn|currency }}</span></dd>
          <dt class="col-6 text-right">Work Location:</dt>
          <dd class="col-6 text-left"><i class="fas fa-map-marker"></i>&nbsp;{{ vm.opportunity.location }}</dd>
          <dt class="col-6 text-right">On-site requirements:</dt>
          <dd class="col-6 text-left">
            <span ng-if="vm.opportunity.onsite == 'offsite'">In-person work NOT required</span>
            <span ng-if="vm.opportunity.onsite == 'onsite'">In-person work required</span>
            <span ng-if="vm.opportunity.onsite == 'mixed'">Some in-person work required</span>
          </dd>
          <dt class="col-6 text-right">Required skills:</dt>
          <dd class="col-6 text-left">
            <div class="label-list">
              <label class="label label-skill" ng-repeat="code in vm.opportunity.skills">{{code}}</label>
            </div>
          </dd>
        </dl>
      </div>
      <div class="col-lg-7 opp-dl-description">
        <dl class="row">
          <dt class="col-6 text-right">Program:</dt>
          <dd class="col-6 text-left">
            <a ng-if="vm.opportunity.program" id="programs.view" ui-sref="programs.view({programId:vm.opportunity.program.code})"><i
                class="fas fa-university"></i> {{vm.opportunity.program.title}}</a>
            <span ng-if="!vm.opportunity.program" class="text-muted">No program</span>
          </dd>
          <dt class="col-6 text-right">Project:</dt>
          <dd class="col-6 text-left">
            <a ng-if="vm.opportunity.project" id="projects.view" ui-sref="projects.view({projectId:vm.opportunity.project.code})"><i
                class="fas fa-chart-pie"></i> {{vm.opportunity.project.name}}</a>
            <span ng-if="!vm.opportunity.project" class="text-muted">No project</span>
          </dd>

          <dt class="col-6 text-right">Code:</dt>
          <dd class="col-6 text-left">
            <a ng-if="vm.opportunity.github && vm.opportunity.github.length > 0" href="{{vm.opportunity.github}}" rel="nofollow"
              target="_blank"><i class="fab fa-github"></i> GitHub Repository</a>
          </dd>
        </dl>
      </div>
    </div>
    
    <div class="row py-5">
      <div class="col">
        <h4>Background</h4>
        <p ng-bind-html="vm.display.description"></p>
      </div>
    </div>

    <div class="row py-5">
      <div class="col">
        <h4>Acceptance Criteria</h4>
        <p>This is a <span class="strong">fixed-price</span> opportunity governed by the <a href="/api/proposals/download/terms/cwu1"
            target="_blank"> terms</a> of our lightweight procurement model, <a href="/codewithus"
            target="_blank">Code With Us</a>.</p> To be paid the fixed price for this opportunity, you need to meet
        all
        of the following criteria:</p>
        <p ng-bind-html="vm.display.criteria"></p>
      </div>
    </div>

    <div class="row py-5">
      <div class="col">
        <h4>How to Apply</h4>
        <p>Submit your Proposal before <span class="strong">{{vm.deadline}}</span>.</p>
        <p>We plan to assign this opportunity by <span class="strong">{{vm.assignment}}</span> with work to start on <span class="strong">{{vm.start}}</span>.</p>
        <h5>Proposal Evaluation Criteria</h5>
        <p>Your Proposal will be scored by this criteria:</p>
        <p ng-bind-html="vm.display.evaluation"></p>
      </div>
    </div>

    <!-- // Proposal Application Directive // -->
    <div class="row" ng-if="true && vm.closing !== 'CLOSED'">
      <div class="col">
        <proposal-apply opportunity="vm.opportunity" proposal="vm.myproposal"></proposal-apply>
        <!-- Alert if user is not signed in -->
        <div ng-if="!vm.loggedIn && vm.closing != 'CLOSED'" class="alert alert-warning">
          To apply on this opportunity you need to <a ui-sref="authentication.signin"> Sign In</a>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <div class="alert alert-warning">
          <span class="font-weight-bold">Got Questions?</span> <a href="{{vm.opportunity.issueUrl}}" rel="nofollow" target="_blank">Visit the GitHub issue for this opportunity</a> and post a comment. <i class="fas fa-comments fa-lg"></i>
        </div>        
      </div>
    </div>

    <div class="row pt-5">
      <div class="col">
        <div class="small text-muted">
          Published on <span ng-bind="vm.opportunity.lastPublished | date:'mediumDate'"></span> by <span ng-if="vm.opportunity.createdBy"
          ng-bind="vm.opportunity.createdBy.displayName"></span><span ng-if="!vm.opportunity.createdBy">Deleted User</span>. Last updated on <span ng-bind="vm.opportunity.updated | date:'mediumDate'"></span> by <span ng-if="vm.opportunity.updatedBy"
          ng-bind="vm.opportunity.updatedBy.displayName"></span><span ng-if="!vm.opportunity.updatedBy">Deleted User</span>.
        </div>
      </div>
    </div>

  </div>

</section>
